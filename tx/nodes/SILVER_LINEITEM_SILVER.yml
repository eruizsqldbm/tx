name: LINEITEM_SILVER
id: cd0997df-b05f-4309-b94c-11bddc015e0a
storageLocationId: 12b1677e-627b-400d-b257-a26c04e6c2f1
templateId: e46ef9bc-30f7-4348-be90-17df448c7615
materialization: table
isSource: false
columns:
  - name: LINE_NUMBER
    dataType: VARCHAR(16777216)
    allowNulls: false
    defaultValue: ''
    description: ''
    id: 63e019eb-f118-4ee3-8453-de61cb29cda3
    useQuotes: false
    isPK: true
  - name: SALES_ORDER_ID
    dataType: VARCHAR(16777216)
    allowNulls: false
    defaultValue: ''
    description: ''
    id: 2c14f4a3-f028-450f-8fd9-902b372e75ed
    useQuotes: false
    isPK: true
  - name: PART_ID
    dataType: VARCHAR(16777216)
    allowNulls: false
    defaultValue: ''
    description: ''
    id: 131cb731-edff-4447-8728-3e37b417ca33
    useQuotes: false
  - name: SUPPLIER_ID
    dataType: VARCHAR(16777216)
    allowNulls: false
    defaultValue: ''
    description: ''
    id: 909865c2-1cf4-4586-9b4b-686bf63c8237
    useQuotes: false
  - name: QUANTITY
    dataType: NUMBER(38,0)
    allowNulls: true
    defaultValue: ''
    description: ''
    id: 46fdec2a-013f-4a30-8c7d-af97b793082a
    useQuotes: false
  - name: EXTENDED_PRICE_USD
    dataType: NUMBER(18,2)
    allowNulls: true
    defaultValue: ''
    description: ''
    id: d76824f1-f320-4710-b2ed-1ba2180515ee
    useQuotes: false
  - name: DISCOUNT_PERCENT
    dataType: NUMBER(5,2)
    allowNulls: true
    defaultValue: ''
    description: ''
    id: 958e984b-fdc7-483c-86b3-7f1bcfa0f69a
    useQuotes: false
  - name: TAX_PERCENT
    dataType: NUMBER(5,2)
    allowNulls: true
    defaultValue: ''
    description: ''
    id: 8103e466-1eb9-4f29-bb64-3d15531c67c2
    useQuotes: false
  - name: RETURN_FLAG
    dataType: VARCHAR(3)
    allowNulls: true
    defaultValue: ''
    description: ''
    id: bdaf61b4-8861-428a-91f9-5bc909268eb9
    useQuotes: false
  - name: LINE_STATUS
    dataType: VARCHAR(3)
    allowNulls: true
    defaultValue: ''
    description: ''
    id: be22e9e3-060e-4e35-b9fe-c8fee700df57
    useQuotes: false
  - name: SHIP_DATE
    dataType: DATE
    allowNulls: true
    defaultValue: ''
    description: ''
    id: 883df9df-3f6b-4b86-965a-c1d32c03346a
    useQuotes: false
  - name: COMMIT_DATE
    dataType: DATE
    allowNulls: true
    defaultValue: ''
    description: ''
    id: e5565bdd-59d7-4f11-b8d9-325ea786f065
    useQuotes: false
  - name: RECEIPT_DATE
    dataType: DATE
    allowNulls: true
    defaultValue: ''
    description: ''
    id: 44adfbf4-9bc4-41b2-b3b1-61bdd9cea694
    useQuotes: false
  - name: SHIP_INSTRUCTIONS
    dataType: VARCHAR(16777216)
    allowNulls: true
    defaultValue: ''
    description: ''
    id: c52958ff-2e74-41e3-90c2-1e0bbd254ee6
    useQuotes: false
  - name: SHIP_MODE
    dataType: VARCHAR(30)
    allowNulls: true
    defaultValue: ''
    description: ''
    id: cb3395d6-22d5-4ddd-880f-cd27271b8de5
    useQuotes: false
  - name: COMMENT
    dataType: VARCHAR(16777216)
    allowNulls: true
    defaultValue: ''
    description: ''
    id: c015790f-3821-4720-8d75-524be3978d89
    useQuotes: false
  - name: SOURCE_LOAD_DTS
    dataType: TIMESTAMP_LTZ(9)
    allowNulls: true
    defaultValue: ''
    description: ''
    id: 7f4c29a8-b222-4bbb-9444-d79764621044
    useQuotes: false
  - name: __LOAD_DATE
    dataType: DATE
    allowNulls: true
    defaultValue: ''
    description: ''
    id: 7499bd31-c160-4139-a5e2-1ea871daf5f6
    useQuotes: false
columnSets:
  - id: ffb4b0fa-0696-4726-9705-90b598ba5b5a
    itemName: PK
    setName: PK_LINEITEM_SILVER
    columns:
      - columnId: 63e019eb-f118-4ee3-8453-de61cb29cda3
        position: 1
        name: LINE_NUMBER
        useQuotes: false
      - columnId: 2c14f4a3-f028-450f-8fd9-902b372e75ed
        position: 2
        name: SALES_ORDER_ID
        useQuotes: false
nodeFormat: dynamic
useQuotes: false
truncateBefore: false
preCreate:
  value:
    - ''
  isValidated: false
postCreate:
  value:
    - ''
  isValidated: false
preRun:
  value:
    - ''
  isValidated: false
postRun:
  value:
    - ''
  isValidated: false
rely_button: true
color: '#1C70FF'
logic: |-
  WITH LINEITEM AS (
      SELECT
          LINE_NUMBER,
          SALES_ORDER_ID,
          PART_ID,
          SUPPLIER_ID,
          QUANTITY,
          EXTENDED_PRICE_USD,
          DISCOUNT_PERCENT,
          TAX_PERCENT,
          RETURN_FLAG,
          LINE_STATUS,
          SHIP_DATE,
          COMMIT_DATE,
          RECEIPT_DATE,
          SHIP_INSTRUCTIONS,
          SHIP_MODE,
          COMMENT,
          __LOAD_DTS
      FROM {{ref('BRONZE', 'LINEITEM')}} -- Change this to the appropriate schema.table reference
  )
  ,
  common as (
      SELECT
          --Remove duplicate rows by keeping only the latest version for each LINE_NUMBER + SALES_ORDER_ID
          ROW_NUMBER() OVER (PARTITION BY LINEITEM.LINE_NUMBER, LINEITEM.SALES_ORDER_ID ORDER BY LINEITEM.__LOAD_DTS DESC NULLS FIRST) AS row_num,

          --Handle nulls for LINE_NUMBER
          COALESCE(TRIM(LINEITEM.LINE_NUMBER), 'UNKNOWN') AS LINE_NUMBER,
          
          --Handle nulls for SALES_ORDER_ID
          COALESCE(TRIM(LINEITEM.SALES_ORDER_ID), 'UNKNOWN') AS SALES_ORDER_ID,

          --Handle nulls for PART_ID and SUPPLIER_ID
          COALESCE(TRIM(LINEITEM.PART_ID), 'UNKNOWN') AS PART_ID,
          COALESCE(TRIM(LINEITEM.SUPPLIER_ID), 'UNKNOWN') AS SUPPLIER_ID,

          --Handle numeric columns (cast VARIANT to TEXT first to avoid errors)
          COALESCE(TRY_TO_NUMBER(CAST(LINEITEM.QUANTITY AS TEXT)), 0) AS QUANTITY,
          COALESCE(TRY_TO_DECIMAL(CAST(LINEITEM.EXTENDED_PRICE_USD AS TEXT), 18, 2), 0) AS EXTENDED_PRICE_USD,
          COALESCE(TRY_TO_DECIMAL(CAST(LINEITEM.DISCOUNT_PERCENT AS TEXT), 5, 2), 0) AS DISCOUNT_PERCENT,
          COALESCE(TRY_TO_DECIMAL(CAST(LINEITEM.TAX_PERCENT AS TEXT), 5, 2), 0) AS TAX_PERCENT,

          --Handle RETURN_FLAG and LINE_STATUS
          UPPER(TRIM(LINEITEM.RETURN_FLAG)) AS RETURN_FLAG,
          UPPER(TRIM(LINEITEM.LINE_STATUS)) AS LINE_STATUS,

          --Handle SHIP_DATE, COMMIT_DATE, and RECEIPT_DATE (ensure valid DATE format)
          TRY_TO_DATE(LINEITEM.SHIP_DATE) AS SHIP_DATE,
          TRY_TO_DATE(LINEITEM.COMMIT_DATE) AS COMMIT_DATE,
          TRY_TO_DATE(LINEITEM.RECEIPT_DATE) AS RECEIPT_DATE,

          --Clean and standardize SHIP_INSTRUCTIONS and SHIP_MODE
          REGEXP_REPLACE(TRIM(LINEITEM.SHIP_INSTRUCTIONS), '[^A-Za-z0-9 .,]', '') AS SHIP_INSTRUCTIONS,
          UPPER(TRIM(LINEITEM.SHIP_MODE)) AS SHIP_MODE,

          --Remove special characters from COMMENT field
          REGEXP_REPLACE(TRIM(LINEITEM.COMMENT), '[^A-Za-z0-9 .,]', '') AS COMMENT,

          --Store original load timestamp from Bronze
          LINEITEM.__LOAD_DTS AS SOURCE_LOAD_DTS,

          --Use the Snowflake current date function to track when the row was processed
          CURRENT_DATE() AS __LOAD_DATE
      FROM LINEITEM

      --Filter only the most recent row per LINE_NUMBER + SALES_ORDER_ID
      QUALIFY ROW_NUMBER() OVER (PARTITION BY LINEITEM.LINE_NUMBER, LINEITEM.SALES_ORDER_ID ORDER BY LINEITEM.__LOAD_DTS DESC NULLS FIRST) = 1
  )

  SELECT 
      LINE_NUMBER,
      SALES_ORDER_ID,
      PART_ID,
      SUPPLIER_ID,
      QUANTITY,
      EXTENDED_PRICE_USD,
      DISCOUNT_PERCENT,
      TAX_PERCENT,
      RETURN_FLAG,
      LINE_STATUS,
      SHIP_DATE,
      COMMIT_DATE,
      RECEIPT_DATE,
      SHIP_INSTRUCTIONS,
      SHIP_MODE,
      COMMENT,
      SOURCE_LOAD_DTS,
      __LOAD_DATE
  FROM common
description: ''
logicalName: LINEITEM Silver Table
references:
  d84a46e7-3ba5-4931-9dac-593fa8a67f5a:
    parentTableId: 2cdffcb9-f169-4016-85ff-d02667e87fd3
    id: d84a46e7-3ba5-4931-9dac-593fa8a67f5a
