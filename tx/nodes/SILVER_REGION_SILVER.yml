name: REGION_SILVER
id: 65086349-098f-4144-bd1e-3ca00123afa5
storageLocationId: 12b1677e-627b-400d-b257-a26c04e6c2f1
templateId: e46ef9bc-30f7-4348-be90-17df448c7615
materialization: table
isSource: false
columns:
  - name: REGION_ID
    dataType: VARCHAR(16777216)
    allowNulls: false
    defaultValue: ''
    description: ''
    id: 86368b70-f913-4361-ac82-db2873f7e556
    useQuotes: false
    isPK: true
  - name: NAME
    dataType: VARCHAR(75)
    allowNulls: false
    defaultValue: ''
    description: ''
    id: 5f3a8c9c-3243-4789-9c36-ae1362be4811
    useQuotes: false
  - name: COMMENT
    dataType: VARCHAR(16777216)
    allowNulls: true
    defaultValue: ''
    description: ''
    id: a05ed32f-33b5-46cd-bad4-8379e64c8a69
    useQuotes: false
  - name: SOURCE_LOAD_DTS
    dataType: TIMESTAMP_LTZ(9)
    allowNulls: true
    defaultValue: ''
    description: ''
    id: 82e81af4-47a9-4aaa-b1ff-2b9de5967549
    useQuotes: false
  - name: __LOAD_DATE
    dataType: DATE
    allowNulls: true
    defaultValue: ''
    description: ''
    id: a2144364-deff-435f-b4ec-b3038caff674
    useQuotes: false
columnSets:
  - id: f76a178c-3d63-4cfa-ab42-c9d792b204a3
    itemName: PK
    setName: PK_REGION_SILVER
    columns:
      - columnId: 86368b70-f913-4361-ac82-db2873f7e556
        position: 1
        name: REGION_ID
        useQuotes: false
nodeFormat: dynamic
useQuotes: false
truncateBefore: false
preCreate:
  value:
    - ''
  isValidated: false
postCreate:
  value:
    - ''
  isValidated: false
preRun:
  value:
    - ''
  isValidated: false
postRun:
  value:
    - ''
  isValidated: false
rely_button: true
color: '#1C70FF'
logic: |
  WITH REGION AS (
      SELECT
          REGION_ID,
          NAME,
          COMMENT,
          __LOAD_DTS
      FROM {{ref('BRONZE', 'REGION')}} -- Change this to the appropriate schema.table reference
  )
  ,
  common as (
      SELECT
          -- 1. Remove duplicate rows by keeping only the latest version for each REGION_ID
          ROW_NUMBER() OVER (PARTITION BY REGION.REGION_ID ORDER BY REGION.__LOAD_DTS DESC NULLS FIRST) AS row_num,

          -- 2. Handle nulls for REGION_ID
          COALESCE(TRIM(REGION.REGION_ID), 'UNKNOWN') AS REGION_ID,
          
          -- 3. Clean and standardize NAME
          INITCAP(TRIM(REGION.NAME)) AS NAME,

          -- 4. Remove special characters from COMMENT field
          REGEXP_REPLACE(TRIM(REGION.COMMENT), '[^A-Za-z0-9 .,]', '') AS COMMENT,

          -- 5. Store original load timestamp from Bronze
          REGION.__LOAD_DTS AS SOURCE_LOAD_DTS,

          -- 6. Use the Snowflake current date function to track when the row was processed
          CURRENT_DATE() AS __LOAD_DATE
      FROM REGION

      -- 7. Filter only the most recent row per REGION_ID
      QUALIFY ROW_NUMBER() OVER (PARTITION BY REGION.REGION_ID ORDER BY REGION.__LOAD_DTS DESC NULLS FIRST) = 1
  )

  SELECT 
      REGION_ID,
      NAME,
      COMMENT,
      SOURCE_LOAD_DTS,
      __LOAD_DATE
  FROM common
description: ''
logicalName: REGION Silver Table
references:
  8699de10-2bbe-481f-b800-403c16f29d68:
    parentTableId: d3dd55ee-ca98-43c8-8a4b-ee8d18363725
    id: 8699de10-2bbe-481f-b800-403c16f29d68
