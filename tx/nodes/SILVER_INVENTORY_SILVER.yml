name: INVENTORY_SILVER
id: cc921404-f683-4a8e-9769-b1edfbc2c124
storageLocationId: 12b1677e-627b-400d-b257-a26c04e6c2f1
templateId: e46ef9bc-30f7-4348-be90-17df448c7615
materialization: table
isSource: false
columns:
  - name: PART_ID
    dataType: VARCHAR(16777216)
    allowNulls: false
    defaultValue: ''
    description: part of unique identifier with ps_suppkey
    id: e4399295-b87c-47e8-8377-8464f94917b0
    useQuotes: false
    isPK: true
  - name: SUPPLIER_ID
    dataType: VARCHAR(16777216)
    allowNulls: false
    defaultValue: ''
    description: part of unique identifier with ps_partkey
    id: c290e844-1d74-4ad1-8fe6-61cb0a6f358e
    useQuotes: false
    isPK: true
  - name: AVAILABLE_AMOUNT
    dataType: NUMBER(38,0)
    allowNulls: false
    defaultValue: ''
    description: number of parts available for sale
    id: 99eafe7f-e3a5-4024-aa4b-2c481335f002
    useQuotes: false
  - name: SUPPLIER_COST_USD
    dataType: NUMBER(18,2)
    allowNulls: false
    defaultValue: ''
    description: original cost paid to supplier
    id: 4e5e1c28-9325-4e22-80a4-60171ca774e5
    useQuotes: false
  - name: COMMENT
    dataType: VARCHAR(16777216)
    allowNulls: true
    defaultValue: ''
    description: ''
    id: e865c8ad-2dc9-4c93-a8e9-32876c8ee9a7
    useQuotes: false
  - name: SOURCE_LOAD_DTS
    dataType: TIMESTAMP_LTZ(9)
    allowNulls: true
    defaultValue: ''
    description: ''
    id: 97c0c3f2-8031-4b13-a824-04e999dc75b2
    useQuotes: false
  - name: __LOAD_DATE
    dataType: DATE
    allowNulls: true
    defaultValue: ''
    description: ''
    id: 5fa7a9c8-d951-4f3c-ba60-875f4dad0f0c
    useQuotes: false
columnSets:
  - id: b5aece58-d49a-4106-82b2-6efc91347438
    itemName: PK
    setName: PK_INVENTORY_SILVER
    columns:
      - columnId: e4399295-b87c-47e8-8377-8464f94917b0
        position: 1
        name: PART_ID
        useQuotes: false
      - columnId: c290e844-1d74-4ad1-8fe6-61cb0a6f358e
        position: 2
        name: SUPPLIER_ID
        useQuotes: false
nodeFormat: dynamic
useQuotes: false
truncateBefore: false
preCreate:
  value:
    - ''
  isValidated: false
postCreate:
  value:
    - ''
  isValidated: false
preRun:
  value:
    - ''
  isValidated: false
postRun:
  value:
    - ''
  isValidated: false
rely_button: true
color: '#1C70FF'
logic: |
  WITH INVENTORY AS (
      SELECT
          PART_ID,
          SUPPLIER_ID,
          AVAILABLE_AMOUNT,
          SUPPLIER_COST_USD,
          COMMENT,
          __LOAD_DTS
      FROM {{ref('BRONZE', 'INVENTORY')}} -- Change this to the appropriate schema.table reference
  )
  ,
  common as (
      SELECT
          --Remove duplicate rows by keeping only the latest version for each PART_ID + SUPPLIER_ID
          ROW_NUMBER() OVER (PARTITION BY INVENTORY.PART_ID, INVENTORY.SUPPLIER_ID ORDER BY INVENTORY.__LOAD_DTS DESC NULLS FIRST) AS row_num,

          --Handle nulls for PART_ID
          COALESCE(TRIM(INVENTORY.PART_ID), 'UNKNOWN') AS PART_ID,
          
          -- Handle nulls for SUPPLIER_ID
          COALESCE(TRIM(INVENTORY.SUPPLIER_ID), 'UNKNOWN') AS SUPPLIER_ID,

          -- Handle available amount as a numeric value, cast from VARIANT (if applicable)
          COALESCE(TRY_TO_NUMBER(CAST(INVENTORY.AVAILABLE_AMOUNT AS TEXT)), 0) AS AVAILABLE_AMOUNT,

          -- Handle supplier cost as a decimal (cast VARIANT to TEXT first to avoid errors)
          COALESCE(TRY_TO_DECIMAL(CAST(INVENTORY.SUPPLIER_COST_USD AS TEXT), 18, 2), 0) AS SUPPLIER_COST_USD,

          --Remove special characters from COMMENT field
          REGEXP_REPLACE(TRIM(INVENTORY.COMMENT), '[^A-Za-z0-9 .,]', '') AS COMMENT,

          --Store original load timestamp from Bronze
          INVENTORY.__LOAD_DTS AS SOURCE_LOAD_DTS,

          -- Use the Snowflake current date function to track when the row was processed
          CURRENT_DATE() AS __LOAD_DATE
      FROM INVENTORY

      --Filter only the most recent row per PART_ID + SUPPLIER_ID
      QUALIFY ROW_NUMBER() OVER (PARTITION BY INVENTORY.PART_ID, INVENTORY.SUPPLIER_ID ORDER BY INVENTORY.__LOAD_DTS DESC NULLS FIRST) = 1
  )

  SELECT 
      PART_ID,
      SUPPLIER_ID,
      AVAILABLE_AMOUNT,
      SUPPLIER_COST_USD,
      COMMENT,
      SOURCE_LOAD_DTS,
      __LOAD_DATE
  FROM common
description: ''
logicalName: INVENTORY Silver Table
references:
  c8a05023-83c3-47c5-82c9-fdac563fac01:
    parentTableId: d5d3133a-d442-4b2f-bd1c-60c319dd0497
    id: c8a05023-83c3-47c5-82c9-fdac563fac01
