name: SUPPLIER_SILVER
id: f01fa6cd-cc5f-4690-a97d-e1d3274215c6
storageLocationId: 12b1677e-627b-400d-b257-a26c04e6c2f1
templateId: e46ef9bc-30f7-4348-be90-17df448c7615
materialization: table
isSource: false
columns:
  - name: SUPPLIER_ID
    dataType: VARCHAR(16777216)
    allowNulls: false
    defaultValue: ''
    description: ''
    id: aef473d8-52cd-4249-980a-315b61ed6270
    useQuotes: false
    isPK: true
  - name: NAME
    dataType: VARCHAR(16777216)
    allowNulls: false
    defaultValue: ''
    description: ''
    id: 0961bcad-4173-46be-80d0-74b2b97ce5a3
    useQuotes: false
  - name: ADDRESS
    dataType: VARCHAR(16777216)
    allowNulls: false
    defaultValue: ''
    description: ''
    id: a100e82b-ae53-4d20-a46f-f5f428096757
    useQuotes: false
  - name: LOCATION_ID
    dataType: VARCHAR(16777216)
    allowNulls: false
    defaultValue: ''
    description: ''
    id: ce43700a-e43a-4bc6-9c3f-aa7208b9fede
    useQuotes: false
  - name: PHONE
    dataType: VARCHAR(16777216)
    allowNulls: false
    defaultValue: ''
    description: ''
    id: 4b458c10-fb08-448f-a1db-a4e0e6eaa41e
    useQuotes: false
  - name: ACCOUNT_BALANCE_USD
    dataType: NUMBER(18,2)
    allowNulls: false
    defaultValue: ''
    description: ''
    id: 5bce73eb-c870-466f-886c-1a0b8bc35f3b
    useQuotes: false
  - name: COMMENT
    dataType: VARCHAR(16777216)
    allowNulls: true
    defaultValue: ''
    description: ''
    id: 92a98743-8b61-4e57-8d2d-c44b21358801
    useQuotes: false
  - name: SOURCE_LOAD_DTS
    dataType: TIMESTAMP_LTZ(9)
    allowNulls: true
    defaultValue: ''
    description: ''
    id: 07e7cffd-c5cd-479c-ba1a-f1c5ab789684
    useQuotes: false
  - name: __LOAD_DATE
    dataType: DATE
    allowNulls: true
    defaultValue: ''
    description: ''
    id: d6e2b954-2950-4f7a-a505-142a28904a16
    useQuotes: false
columnSets:
  - id: 60211760-2c84-46ae-abff-8801ffc1c135
    itemName: PK
    setName: PK_SUPPLIER_SILVER
    columns:
      - columnId: aef473d8-52cd-4249-980a-315b61ed6270
        position: 1
        name: SUPPLIER_ID
        useQuotes: false
nodeFormat: dynamic
useQuotes: false
truncateBefore: false
preCreate:
  value:
    - ''
  isValidated: false
postCreate:
  value:
    - ''
  isValidated: false
preRun:
  value:
    - ''
  isValidated: false
postRun:
  value:
    - ''
  isValidated: false
rely_button: true
color: '#1C70FF'
logic: |-
  WITH SUPPLIER AS (
      SELECT
          SUPPLIER_ID,
          NAME,
          ADDRESS,
          LOCATION_ID,
          PHONE,
          ACCOUNT_BALANCE_USD,
          COMMENT,
          __LOAD_DTS
      FROM {{ref('BRONZE', 'SUPPLIER')}} -- Change this to the appropriate schema.table reference
  )
  ,
  common as (
      SELECT
          -- 1. Remove duplicate rows by keeping only the latest version for each SUPPLIER_ID
          ROW_NUMBER() OVER (PARTITION BY SUPPLIER.SUPPLIER_ID ORDER BY SUPPLIER.__LOAD_DTS DESC NULLS FIRST) AS row_num,

          -- 2. Handle nulls for SUPPLIER_ID and LOCATION_ID
          COALESCE(TRIM(SUPPLIER.SUPPLIER_ID), 'UNKNOWN') AS SUPPLIER_ID,
          COALESCE(TRIM(SUPPLIER.LOCATION_ID), 'UNKNOWN') AS LOCATION_ID,

          -- 3. Clean and standardize NAME and ADDRESS
          INITCAP(TRIM(SUPPLIER.NAME)) AS NAME,
          REGEXP_REPLACE(TRIM(SUPPLIER.ADDRESS), '[^A-Za-z0-9 .,]', '') AS ADDRESS,

          -- 4. Clean and standardize PHONE (removes all non-numeric characters)
          REGEXP_REPLACE(SUPPLIER.PHONE, '[^0-9]', '') AS PHONE,

          -- 5. Handle numeric fields (cast VARIANT to TEXT first to avoid errors)
          COALESCE(TRY_TO_DECIMAL(CAST(SUPPLIER.ACCOUNT_BALANCE_USD AS TEXT), 18, 2), 0) AS ACCOUNT_BALANCE_USD,

          -- 6. Remove special characters from COMMENT field
          REGEXP_REPLACE(TRIM(SUPPLIER.COMMENT), '[^A-Za-z0-9 .,]', '') AS COMMENT,

          -- 7. Store original load timestamp from Bronze
          SUPPLIER.__LOAD_DTS AS SOURCE_LOAD_DTS,

          -- 8. Use the Snowflake current date function to track when the row was processed
          CURRENT_DATE() AS __LOAD_DATE
      FROM SUPPLIER

      -- 9. Filter only the most recent row per SUPPLIER_ID
      QUALIFY ROW_NUMBER() OVER (PARTITION BY SUPPLIER.SUPPLIER_ID ORDER BY SUPPLIER.__LOAD_DTS DESC NULLS FIRST) = 1
  )

  SELECT 
      SUPPLIER_ID,
      NAME,
      ADDRESS,
      LOCATION_ID,
      PHONE,
      ACCOUNT_BALANCE_USD,
      COMMENT,
      SOURCE_LOAD_DTS,
      __LOAD_DATE
  FROM common
description: ''
logicalName: SUPPLIER Silver Table
references:
  20289f2d-f754-4a4e-8a5f-731118cb7ff0:
    parentTableId: 078d0ad4-37e8-48ba-a9e5-4f4418be869f
    id: 20289f2d-f754-4a4e-8a5f-731118cb7ff0
